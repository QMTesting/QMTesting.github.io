{% assign current_post = page %}
{% assign primary_category = current_post.categories[0] %}
{% assign related_posts = site.posts %}
{% assign counter = 0 %}

<div class="related-posts-grid">
  {% for post in related_posts %}
    {% if post.url != current_post.url and post.categories contains primary_category %}
      <div class="related-post">
        <a href="{{ post.url }}">
          <img src="{{ post.image }}" alt="{{ post.title }}" style="width:100%;height:auto;">
          <p>{{ post.title }}</p>
        </a>
      </div>
      {% assign counter = counter | plus: 1 %}
      {% if counter == 4 %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}
</div>
